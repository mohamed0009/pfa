<div class="learning-paths-container">
  <header class="page-header">
    <div class="header-content">
      <h1>
        <span class="material-icons">route</span>
        Parcours Personnalisés
      </h1>
      <p>Adaptez les parcours d'apprentissage à vos apprenants</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="generateRecommendations()" [disabled]="isLoading">
        <span class="material-icons">auto_awesome</span>
        {{ isLoading ? 'Génération...' : 'Générer Recommandations ML' }}
      </button>
      <button class="btn btn-primary" (click)="createPath()">
        <span class="material-icons">add</span>
        Créer un Parcours
      </button>
    </div>
  </header>

  <!-- Filters -->
  <div class="filters-card">
    <div class="filter-group">
      <label>Afficher</label>
      <select [(ngModel)]="filterType" class="form-control" (change)="applyFilters()">
        <option value="all">Tous les parcours</option>
        <option value="active">Actifs</option>
        <option value="draft">Brouillons</option>
        <option value="completed">Complétés</option>
      </select>
    </div>

    <div class="filter-group">
      <label>Formation</label>
      <select [(ngModel)]="selectedFormation" class="form-control" (change)="applyFilters()">
        <option value="all">Toutes les formations</option>
        <option *ngFor="let formation of formations" [value]="formation.id">{{ formation.title }}</option>
      </select>
    </div>

    <div class="search-group">
      <span class="material-icons">search</span>
      <input 
        type="text" 
        [(ngModel)]="searchTerm"
        (input)="applyFilters()"
        placeholder="Rechercher un apprenant..."
        class="search-input">
    </div>
  </div>

  <!-- Paths Grid -->
  <div class="paths-grid">
    <div *ngFor="let path of filteredPaths" class="path-card">
      <div class="path-header">
        <div class="student-info">
          <div class="student-avatar">
            <span class="material-icons">person</span>
          </div>
          <div>
            <h3>{{ path.studentName }}</h3>
            <p>{{ path.formationTitle || path.formationName }}</p>
          </div>
        </div>
        <span class="status-badge" [class]="path.status">
          {{ getStatusLabel(path.status) }}
        </span>
      </div>

      <div class="path-content">
        <div class="path-progress">
          <div class="progress-header">
            <span>Progression</span>
            <strong>{{ path.completionRate || 0 }}%</strong>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar" [style.width.%]="path.completionRate || 0"></div>
          </div>
        </div>

        <div class="path-stats">
          <div class="stat-item">
            <span class="material-icons">menu_book</span>
            <span>{{ path.modulesCount || path.modules.length || 0 }} modules</span>
          </div>
          <div class="stat-item">
            <span class="material-icons">schedule</span>
            <span>{{ path.estimatedTime || 0 }}h estimées</span>
          </div>
          <div class="stat-item">
            <span class="material-icons">star</span>
            <span>{{ path.averageScore || 0 }}/100</span>
          </div>
        </div>

        <div class="path-adaptations" *ngIf="(path.adaptations && path.adaptations.length > 0) || (path.adjustments && path.adjustments.length > 0)">
          <h4>
            <span class="material-icons">psychology</span>
            Recommandations basées sur l'analyse ML
          </h4>
          <div class="adaptation-chips">
            <span *ngFor="let adaptation of (path.adaptations || [])" class="adaptation-chip" [class]="adaptation.type">
              {{ adaptation.label }}
            </span>
            <span *ngFor="let adj of (path.adjustments || [])" class="adaptation-chip ml-recommendation">
              <span class="material-icons">auto_awesome</span>
              {{ adj.reason || 'Recommandation ML' }}
              <span class="confidence-badge" *ngIf="adj.confidenceScore">
                {{ (adj.confidenceScore * 100).toFixed(0) }}%
              </span>
            </span>
          </div>
          <div class="ml-details" *ngIf="path.adjustments && path.adjustments.length > 0">
            <div *ngIf="path.adjustments[0].courseTitle" class="recommended-course-box">
              <p class="recommended-course">
                <strong>Cours recommandé:</strong> {{ path.adjustments[0].courseTitle }}
              </p>
              <p class="ml-info" *ngIf="path.predictedDifficulty">
                <span class="material-icons">trending_up</span>
                Niveau prédit: <strong>{{ path.predictedDifficulty }}</strong>
              </p>
            </div>
            <p class="conversation-excerpt" *ngIf="path.adjustments[0].conversationExcerpt">
              <em>"{{ path.adjustments[0].conversationExcerpt }}"</em>
            </p>
            <div class="ml-analysis-info" *ngIf="path.confidenceScore">
              <span class="material-icons">model_training</span>
              <span>Analyse ML: Confiance {{ (path.confidenceScore * 100).toFixed(0) }}%</span>
            </div>
          </div>
        </div>

        <div class="ai-suggestions" *ngIf="path.aiSuggestions && path.aiSuggestions.length > 0">
          <div class="suggestion-header">
            <span class="material-icons">lightbulb</span>
            <span>Analyse IA des conversations</span>
          </div>
          <ul>
            <li *ngFor="let suggestion of path.aiSuggestions">
              <span class="material-icons">chat</span>
              {{ suggestion }}
            </li>
          </ul>
        </div>

        <div class="ml-indicator" *ngIf="path.confidenceScore">
          <span class="material-icons">model_training</span>
          <span>Analyse ML: Confiance {{ (path.confidenceScore * 100).toFixed(0) }}%</span>
        </div>
      </div>

      <div class="path-actions">
        <button class="btn btn-secondary" (click)="viewPath(path.id)">
          <span class="material-icons">visibility</span>
          Voir Détails
        </button>
        <button class="btn btn-primary" *ngIf="path.status === 'draft'" (click)="applyPath(path.id)">
          <span class="material-icons">check_circle</span>
          Appliquer
        </button>
        <button class="btn btn-primary" *ngIf="path.status !== 'draft'" (click)="adjustPath(path.id)">
          <span class="material-icons">tune</span>
          Ajuster
        </button>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="filteredPaths.length === 0 && !isLoading" class="empty-state">
    <span class="material-icons">route</span>
    <h3>Aucun parcours personnalisé trouvé</h3>
    <p>
      Les recommandations sont générées automatiquement par le modèle ML<br>
      basé sur l'analyse des conversations de chat des apprenants.
    </p>
    <div class="info-box">
      <span class="material-icons">info</span>
      <div>
        <strong>Comment ça fonctionne ?</strong>
        <ul>
          <li>Le modèle ML analyse les conversations entre les apprenants et le chat IA</li>
          <li>Après 5 messages, des recommandations de cours sont générées automatiquement</li>
          <li>Les recommandations apparaissent ici une fois créées par le système</li>
        </ul>
      </div>
    </div>
    <button class="btn btn-primary" (click)="loadData()">
      <span class="material-icons">refresh</span>
      Actualiser
    </button>
  </div>

  <!-- AI Collaboration Panel -->
  <div class="ai-panel" *ngIf="showAIPanel">
    <div class="ai-panel-header">
      <h3>
        <span class="material-icons">psychology</span>
        Collaboration avec l'IA
      </h3>
      <button class="btn-icon" (click)="showAIPanel = false">
        <span class="material-icons">close</span>
      </button>
    </div>

    <div class="ai-panel-content">
      <p>
        <span class="material-icons">psychology</span>
        L'IA a analysé les conversations de chat des apprenants avec le modèle ML et suggère les recommandations suivantes :
      </p>
      
      <div class="ai-recommendations">
        <div *ngFor="let recommendation of aiRecommendations" class="recommendation-card">
          <div class="recommendation-header">
            <span class="material-icons">{{ recommendation.icon }}</span>
            <div>
              <strong>{{ recommendation.studentName }}</strong>
              <span class="ml-badge" *ngIf="recommendation.confidenceScore">
                <span class="material-icons">model_training</span>
                ML: {{ (recommendation.confidenceScore * 100).toFixed(0) }}%
              </span>
            </div>
          </div>
          <p class="recommendation-text">{{ recommendation.suggestion }}</p>
          <div class="recommendation-details" *ngIf="recommendation.courseTitle || recommendation.conversationExcerpt">
            <p *ngIf="recommendation.courseTitle" class="course-name">
              <span class="material-icons">book</span>
              Cours: {{ recommendation.courseTitle }}
            </p>
            <p *ngIf="recommendation.conversationExcerpt" class="conversation-excerpt">
              <span class="material-icons">chat</span>
              Extrait de conversation: "{{ recommendation.conversationExcerpt }}"
            </p>
          </div>
          <div class="recommendation-actions">
            <button class="btn btn-sm btn-secondary" (click)="dismissRecommendation(recommendation.id)">
              Ignorer
            </button>
            <button class="btn btn-sm btn-primary" (click)="applyRecommendation(recommendation.id)">
              Appliquer
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Chargement des parcours...</p>
  </div>
</div>



