<div class="course-player" *ngIf="course">
  <!-- Top Navigation Bar -->
  <header class="player-header">
    <div class="header-left">
      <button class="nav-btn" [routerLink]="['/user/courses']" title="Retour aux cours">
        <span class="material-icons">arrow_back</span>
      </button>
      <div class="course-info">
        <h2>{{ course.title }}</h2>
        <p *ngIf="currentLesson">{{ currentLesson.title }}</p>
      </div>
    </div>

    <div class="header-right">
      <button class="icon-btn" (click)="toggleAIChat()" title="Coach IA">
        <span class="material-icons">psychology</span>
        <span class="badge" *ngIf="aiSession && aiSession.messages.length > 1">{{aiSession.messages.length - 1}}</span>
      </button>
      <button class="icon-btn" title="Notes">
        <span class="material-icons">note_add</span>
      </button>
      <button class="icon-btn" title="Ressources">
        <span class="material-icons">folder</span>
      </button>
    </div>
  </header>

  <!-- Main Content Area -->
  <div class="player-container">
    <!-- Sidebar (Course Navigation) -->
    <aside class="player-sidebar" [class.closed]="!sidebarOpen">
      <div class="sidebar-header">
        <h3>Contenu du cours</h3>
        <button class="close-btn" (click)="toggleSidebar()">
          <span class="material-icons">{{ sidebarOpen ? 'chevron_left' : 'chevron_right' }}</span>
        </button>
      </div>

      <div class="sidebar-content">
        <div class="module" *ngFor="let module of course.syllabus">
          <div class="module-header">
            <div class="module-title">
              <h4>Module {{ module.moduleNumber }}</h4>
              <p>{{ module.title }}</p>
            </div>
            <div class="module-progress">
              <span class="progress-text">{{ getModuleProgress(module) }}%</span>
            </div>
          </div>

          <div class="lessons-list">
            <button 
              class="lesson-item" 
              *ngFor="let lesson of module.lessons"
              [class.active]="isLessonActive(lesson)"
              [class.completed]="lesson.isCompleted"
              (click)="selectLesson(lesson)">
              <span class="material-icons lesson-icon">
                {{ getLessonIcon(lesson.type) }}
              </span>
              <div class="lesson-info">
                <p class="lesson-title">{{ lesson.title }}</p>
                <p class="lesson-meta">{{ lesson.duration }} min</p>
              </div>
              <span class="material-icons check-icon" *ngIf="lesson.isCompleted">
                check_circle
              </span>
              <span class="material-icons play-icon" *ngIf="isLessonActive(lesson)">
                play_arrow
              </span>
            </button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Player Area -->
    <main class="player-main">
      <!-- Lesson Content -->
      <div class="lesson-content">
        <div class="lesson-header">
          <div class="lesson-title-section">
            <h1>{{ currentLesson?.title }}</h1>
            <p class="lesson-description">{{ currentLesson?.description }}</p>
          </div>

          <div class="lesson-actions">
            <button 
              class="btn btn-outline" 
              *ngIf="currentLesson && !currentLesson.isCompleted"
              (click)="markLessonComplete()">
              <span class="material-icons">check</span>
              Marquer comme terminé
            </button>
            <button 
              class="btn btn-completed" 
              *ngIf="currentLesson && currentLesson.isCompleted"
              disabled>
              <span class="material-icons">check_circle</span>
              Terminé
            </button>
          </div>
        </div>

        <!-- Video Player -->
        <div class="video-container" *ngIf="currentLesson && currentLesson.type === 'video'">
          <iframe 
            *ngIf="safeVideoUrl"
            [src]="safeVideoUrl"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen>
          </iframe>
        </div>

        <!-- Quiz Content -->
        <div class="quiz-content" *ngIf="currentLesson?.type === 'quiz' && currentQuiz && !isQuizSubmitted">
          <!-- Timer -->
          <div class="quiz-timer" [class.warning]="timeRemaining < 300">
            <span class="material-icons">schedule</span>
            <span class="timer-text">{{ getQuizTimeFormatted() }}</span>
          </div>

          <!-- Progress Bar -->
          <div class="quiz-progress">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="getQuizProgressPercentage()"></div>
            </div>
            <p class="progress-text">
              Question {{ currentQuestionIndex + 1 }} sur {{ currentQuiz.questions.length }} • 
              {{ userAnswers.size }} / {{ currentQuiz.questions.length }} réponses
            </p>
          </div>

          <!-- Current Question -->
          <div class="question-container" *ngIf="getCurrentQuestion() as question">
            <div class="question-header">
              <span class="question-number">Question {{ question.questionNumber }}</span>
              <span class="question-points">{{ question.points }} points</span>
            </div>

            <h2 class="question-text">{{ question.question }}</h2>

            <!-- Multiple Choice -->
            <div class="options-list" *ngIf="question.type === 'multiple-choice' && question.options">
              <div 
                class="option-item"
                *ngFor="let option of question.options; let i = index"
                [class.selected]="getUserQuizAnswer(question.id) === option.id"
                (click)="selectQuizAnswer(option.id)">
                <div class="option-radio">
                  <span class="radio-circle" *ngIf="getUserQuizAnswer(question.id) === option.id"></span>
                </div>
                <div class="option-text">
                  <span class="option-letter">{{ String.fromCharCode(65 + i) }}.</span>
                  {{ option.text }}
                </div>
              </div>
            </div>

            <!-- True/False -->
            <div class="true-false-options" *ngIf="question.type === 'true-false'">
              <button 
                class="tf-option"
                [class.selected]="getUserQuizAnswer(question.id) === 'true'"
                (click)="selectQuizAnswer('true')">
                <span class="material-icons">check_circle</span>
                Vrai
              </button>
              <button 
                class="tf-option"
                [class.selected]="getUserQuizAnswer(question.id) === 'false'"
                (click)="selectQuizAnswer('false')">
                <span class="material-icons">cancel</span>
                Faux
              </button>
            </div>

            <!-- Short Answer -->
            <div class="short-answer" *ngIf="question.type === 'short-answer'">
              <textarea 
                [value]="getUserQuizAnswer(question.id) || ''"
                (input)="selectQuizAnswer($any($event.target).value)"
                placeholder="Saisissez votre réponse..."
                rows="4">
              </textarea>
            </div>
          </div>

          <!-- Quiz Navigation -->
          <div class="quiz-navigation">
            <button 
              class="btn-nav"
              [disabled]="currentQuestionIndex === 0"
              (click)="previousQuizQuestion()">
              <span class="material-icons">chevron_left</span>
              Précédente
            </button>

            <div class="questions-dots">
              <button 
                *ngFor="let q of currentQuiz.questions; let i = index"
                class="question-dot"
                [class.active]="i === currentQuestionIndex"
                [class.answered]="isQuizQuestionAnswered(q.id)"
                (click)="goToQuizQuestion(i)">
                {{ i + 1 }}
              </button>
            </div>

            <button 
              class="btn-nav"
              *ngIf="currentQuestionIndex < currentQuiz.questions.length - 1"
              (click)="nextQuizQuestion()">
              Suivante
              <span class="material-icons">chevron_right</span>
            </button>

            <button 
              class="btn-nav btn-submit"
              *ngIf="currentQuestionIndex === currentQuiz.questions.length - 1"
              [disabled]="!canSubmitQuiz()"
              (click)="submitQuiz()">
              <span class="material-icons">send</span>
              Soumettre le Quiz
            </button>
          </div>
        </div>

        <!-- Quiz Results -->
        <div class="quiz-results" *ngIf="currentLesson?.type === 'quiz' && isQuizSubmitted && currentQuiz">
          <div class="results-container">
            <div class="results-header" [class.passed]="quizPassed" [class.failed]="!quizPassed">
              <span class="material-icons result-icon">
                {{ quizPassed ? 'check_circle' : 'cancel' }}
              </span>
              <h1>{{ quizPassed ? 'Félicitations!' : 'Quiz non réussi' }}</h1>
              <p *ngIf="quizPassed">Vous avez réussi le quiz avec succès!</p>
              <p *ngIf="!quizPassed">Vous devez obtenir au moins {{ currentQuiz.passingScore }}% pour réussir</p>
            </div>

            <div class="score-display">
              <div class="score-circle" [class.passed]="quizPassed">
                <span class="score-value">{{ quizScore }}%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Regular Lesson Content (Non-Quiz) -->
        <div *ngIf="currentLesson?.type !== 'quiz'">
          <!-- Tabs for Notes, Transcript, etc. -->
          <div class="lesson-tabs">
            <button class="tab active">
              <span class="material-icons">description</span>
              Transcription
            </button>
            <button class="tab">
              <span class="material-icons">note</span>
              Mes notes
            </button>
            <button class="tab">
              <span class="material-icons">forum</span>
              Discussions
            </button>
          </div>

          <!-- Transcript/Notes Content -->
          <div class="lesson-body">
            <div class="transcript" *ngIf="currentLesson?.transcript">
              <h3>Transcription de la vidéo</h3>
              <p>{{ currentLesson?.transcript }}</p>
            </div>
            <div class="transcript" *ngIf="!currentLesson?.transcript">
              <p class="empty-state">La transcription sera disponible prochainement.</p>
            </div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="lesson-navigation">
          <button 
            class="btn btn-nav" 
            (click)="goToPreviousLesson()"
            [disabled]="!hasPreviousLesson()">
            <span class="material-icons">chevron_left</span>
            Leçon précédente
          </button>
          <button 
            class="btn btn-nav btn-next" 
            (click)="goToNextLesson()"
            [disabled]="!hasNextLesson()">
            Leçon suivante
            <span class="material-icons">chevron_right</span>
          </button>
        </div>
      </div>
    </main>

    <!-- AI Chat Panel (Floating) -->
    <div class="ai-chat-panel" *ngIf="aiChatOpen" [class.open]="aiChatOpen">
      <div class="chat-header">
        <div class="chat-title">
          <span class="material-icons">psychology</span>
          <h3>Coach IA</h3>
        </div>
        <button class="close-chat-btn" (click)="toggleAIChat()">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="chat-messages">
        <div 
          class="message" 
          *ngFor="let message of aiSession?.messages"
          [class.user-message]="message.role === 'user'"
          [class.ai-message]="message.role === 'ai'">
          <div class="message-avatar">
            <span class="material-icons" *ngIf="message.role === 'ai'">psychology</span>
            <span class="material-icons" *ngIf="message.role === 'user'">person</span>
          </div>
          <div class="message-content">
            <p>{{ message.content }}</p>
            <span class="message-time">{{ message.timestamp | date:'short' }}</span>
          </div>
        </div>
      </div>

      <div class="chat-input">
        <input 
          type="text" 
          [(ngModel)]="aiMessage"
          (keyup.enter)="sendAIMessage()"
          placeholder="Posez une question au coach IA...">
        <button class="send-btn" (click)="sendAIMessage()" [disabled]="!aiMessage.trim()">
          <span class="material-icons">send</span>
        </button>
      </div>

      <div class="chat-suggestions">
        <p>Suggestions :</p>
        <button class="suggestion-chip" (click)="aiMessage = 'Peux-tu m\'expliquer ce concept ?'; sendAIMessage()">
          Expliquer ce concept
        </button>
        <button class="suggestion-chip" (click)="aiMessage = 'Donne-moi un exemple pratique'; sendAIMessage()">
          Exemple pratique
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading State -->
<div class="loading-state" *ngIf="!course">
  <div class="spinner"></div>
  <p>Chargement du cours...</p>
</div>




