<div class="quiz-player" *ngIf="quiz && !isSubmitted">
  <!-- Header with Timer -->
  <div class="quiz-header">
    <div class="quiz-info">
      <h1>{{ quiz.title }}</h1>
      <p>{{ quiz.description }}</p>
    </div>
    
    <div class="timer" [class.warning]="timeRemaining < 300">
      <span class="material-icons">schedule</span>
      <span class="time">{{ getTimeFormatted() }}</span>
    </div>
  </div>

  <!-- Progress Bar -->
  <div class="progress-section">
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
    </div>
    <p class="progress-text">
      Question {{ currentQuestionIndex + 1 }} sur {{ quiz.questions.length }} •
      {{ userAnswers.size }} / {{ quiz.questions.length }} réponses
    </p>
  </div>

  <!-- Current Question -->
  <div class="question-container" *ngIf="getCurrentQuestion() as question">
    <div class="question-header">
      <span class="question-number">Question {{ question.questionNumber }}</span>
      <span class="question-points">{{ question.points }} points</span>
    </div>

    <h2 class="question-text">{{ question.question }}</h2>

    <!-- Multiple Choice -->
    <div class="options-list" *ngIf="question.type === 'MULTIPLE_CHOICE' && question.options">
      <div 
        class="option-item"
        *ngFor="let option of question.options; let i = index"
        [class.selected]="getUserAnswer(question.id) === option.id"
        (click)="selectAnswer(option.id)">
        <div class="option-radio">
          <span class="radio-circle"></span>
        </div>
        <div class="option-text">
          <span class="option-letter">{{ String.fromCharCode(65 + i) }}.</span>
          {{ option.text }}
        </div>
      </div>
    </div>

    <!-- True/False -->
    <div class="true-false-options" *ngIf="question.type === 'TRUE_FALSE'">
      <button 
        class="tf-option"
        [class.selected]="getUserAnswer(question.id) === 'true'"
        (click)="selectAnswer('true')">
        <span class="material-icons">check_circle</span>
        Vrai
      </button>
      <button 
        class="tf-option"
        [class.selected]="getUserAnswer(question.id) === 'false'"
        (click)="selectAnswer('false')">
        <span class="material-icons">cancel</span>
        Faux
      </button>
    </div>

    <!-- Short Answer -->
    <div class="short-answer" *ngIf="question.type === 'SHORT_ANSWER'">
      <textarea 
        [value]="getUserAnswer(question.id) || ''"
        (input)="selectAnswer($any($event.target).value)"
        placeholder="Saisissez votre réponse..."
        rows="4">
      </textarea>
    </div>

    <!-- Code Question -->
    <div class="code-question" *ngIf="question.type === 'CODE'">
      <div class="code-template" *ngIf="question.codeTemplate">
        <pre>{{ question.codeTemplate }}</pre>
      </div>
      <textarea 
        [value]="getUserAnswer(question.id) || ''"
        (input)="selectAnswer($any($event.target).value)"
        placeholder="Écrivez votre code ici..."
        rows="10"
        class="code-input">
      </textarea>
    </div>
  </div>

  <!-- Navigation -->
  <div class="quiz-navigation">
    <button 
      class="btn btn-secondary"
      [disabled]="currentQuestionIndex === 0"
      (click)="previousQuestion()">
      <span class="material-icons">chevron_left</span>
      Précédente
    </button>

    <div class="questions-dots">
      <button 
        *ngFor="let q of quiz.questions; let i = index"
        class="question-dot"
        [class.active]="i === currentQuestionIndex"
        [class.answered]="isQuestionAnswered(q.id)"
        (click)="goToQuestion(i)">
        {{ i + 1 }}
      </button>
    </div>

    <button 
      class="btn btn-secondary"
      *ngIf="currentQuestionIndex < quiz.questions.length - 1"
      (click)="nextQuestion()">
      Suivante
      <span class="material-icons">chevron_right</span>
    </button>

    <button 
      class="btn btn-primary"
      *ngIf="currentQuestionIndex === quiz.questions.length - 1"
      [disabled]="!canSubmit()"
      (click)="submitQuiz()">
      <span class="material-icons">send</span>
      Soumettre le Quiz
    </button>
  </div>
</div>

<!-- Results Screen -->
<div class="quiz-results" *ngIf="isSubmitted">
  <div class="results-container">
    <div class="results-header" [class.passed]="passed" [class.failed]="!passed">
      <span class="material-icons result-icon">
        {{ passed ? 'check_circle' : 'cancel' }}
      </span>
      <h1>{{ passed ? 'Félicitations!' : 'Quiz non réussi' }}</h1>
      <p *ngIf="passed">Vous avez réussi le quiz avec succès!</p>
      <p *ngIf="!passed">Vous devez obtenir au moins {{ quiz?.passingScore }}% pour réussir</p>
    </div>

    <div class="score-display">
      <div class="score-circle" [class.passed]="passed">
        <span class="score-value">{{ score }}%</span>
      </div>
      <p class="score-label">Votre score</p>
    </div>

    <div class="results-info">
      <div class="info-item">
        <span class="material-icons">quiz</span>
        <div>
          <strong>Questions répondues</strong>
          <p>{{ userAnswers.size }} / {{ quiz?.questions?.length || 0 }}</p>
        </div>
      </div>
      <div class="info-item">
        <span class="material-icons">schedule</span>
        <div>
          <strong>Temps passé</strong>
          <p>{{ getTimeFormatted() }}</p>
        </div>
      </div>
      <div class="info-item">
        <span class="material-icons">trending_up</span>
        <div>
          <strong>Score requis</strong>
          <p>{{ quiz?.passingScore }}%</p>
        </div>
      </div>
    </div>

    <!-- Message si échec -->
    <div class="failure-message" *ngIf="!passed">
      <span class="material-icons">info</span>
      <p>
        <strong>Ne vous découragez pas!</strong><br>
        Votre formateur peut vous proposer un module de renforcement pour vous aider à progresser.
      </p>
    </div>

    <!-- Actions -->
    <div class="results-actions">
      <button class="btn btn-secondary" (click)="exitQuiz()">
        <span class="material-icons">home</span>
        Retour au Dashboard
      </button>
      <button 
        class="btn btn-primary" 
        *ngIf="!passed && quiz && quiz.maxAttempts > 1"
        (click)="retryQuiz()">
        <span class="material-icons">refresh</span>
        Réessayer
      </button>
      <button 
        class="btn btn-success" 
        *ngIf="passed"
        (click)="exitQuiz()">
        <span class="material-icons">arrow_forward</span>
        Continuer la formation
      </button>
    </div>
  </div>
</div>

<!-- Loading State -->
<div class="loading-state" *ngIf="!quiz && !isSubmitted">
  <div class="spinner"></div>
  <p>Chargement du quiz...</p>
</div>

