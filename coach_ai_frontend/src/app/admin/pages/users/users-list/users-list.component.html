<div class="users-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-left">
      <h1>Gestion des Utilisateurs</h1>
      <p class="subtitle">Gérez tous les utilisateurs de la plateforme</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <span class="material-icons">person_add</span>
      Ajouter un Utilisateur
    </button>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon" style="background: #4A90E2;">
        <span class="material-icons">people</span>
      </div>
      <div class="stat-content">
        <h3>{{ userStats.total }}</h3>
        <p>Total Utilisateurs</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon" style="background: #2DD4A4;">
        <span class="material-icons">check_circle</span>
      </div>
      <div class="stat-content">
        <h3>{{ userStats.active }}</h3>
        <p>Utilisateurs Actifs</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon" style="background: #FFB800;">
        <span class="material-icons">school</span>
      </div>
      <div class="stat-content">
        <h3>{{ userStats.apprenants }}</h3>
        <p>Apprenants</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon" style="background: #9B51E0;">
        <span class="material-icons">person</span>
      </div>
      <div class="stat-content">
        <h3>{{ userStats.formateurs }}</h3>
        <p>Formateurs</p>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-card">
    <div class="search-box">
      <span class="material-icons">search</span>
      <input
        type="text"
        [(ngModel)]="searchQuery"
        (input)="applyFilters()"
        placeholder="Rechercher par nom, email, formation..."
      />
    </div>

    <div class="filter-group">
      <label>Rôle:</label>
      <select [(ngModel)]="selectedRole" (change)="applyFilters()">
        <option value="all">Tous les rôles</option>
        <option value="Administrateur">Administrateur</option>
        <option value="Formateur">Formateur</option>
        <option value="Apprenant">Apprenant</option>
      </select>
    </div>

    <div class="filter-group">
      <label>Statut:</label>
      <select [(ngModel)]="selectedStatus" (change)="applyFilters()">
        <option value="all">Tous les statuts</option>
        <option value="active">Actif</option>
        <option value="inactive">Inactif</option>
        <option value="pending">En attente</option>
        <option value="suspended">Suspendu</option>
      </select>
    </div>

    <button class="btn-reset" (click)="searchQuery=''; selectedRole='all'; selectedStatus='all'; applyFilters()">
      <span class="material-icons">refresh</span>
      Réinitialiser
    </button>
  </div>

  <!-- Users Table -->
  <div class="table-card">
    <div class="table-header">
      <h2>Liste des Utilisateurs ({{ filteredUsers.length }})</h2>
      <div class="table-actions">
        <button class="btn-icon" title="Exporter">
          <span class="material-icons">download</span>
        </button>
        <button class="btn-icon" title="Actualiser" (click)="loadUsers()">
          <span class="material-icons">refresh</span>
        </button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="users-table">
        <thead>
          <tr>
            <th>Utilisateur</th>
            <th>Email</th>
            <th>Rôle</th>
            <th>Formation</th>
            <th>Niveau</th>
            <th>Statut</th>
            <th>Cours</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of paginatedUsers">
            <td>
              <div class="user-cell">
                <img [src]="user.avatarUrl" [alt]="user.fullName" class="user-avatar">
                <div class="user-info">
                  <span class="user-name">{{ user.fullName }}</span>
                  <span class="user-id">ID: {{ user.id }}</span>
                </div>
              </div>
            </td>
            <td>{{ user.email }}</td>
            <td>
              <span class="badge" [ngClass]="getRoleBadgeClass(user.role)">
                {{ user.role }}
              </span>
            </td>
            <td>{{ user.training }}</td>
            <td>
              <span class="level-badge" [attr.data-level]="user.level">
                {{ user.level }}
              </span>
            </td>
            <td>
              <span class="badge" [ngClass]="getStatusBadgeClass(user.status)">
                {{ user.status === 'active' ? 'Actif' : 
                   user.status === 'inactive' ? 'Inactif' : 
                   user.status === 'pending' ? 'En attente' : 'Suspendu' }}
              </span>
            </td>
            <td>
              <div class="progress-info">
                <span>{{ user.coursesCompleted }} / {{ user.coursesEnrolled }}</span>
              </div>
            </td>
            <td>
              <div class="action-buttons">
                <button 
                  class="btn-icon" 
                  [routerLink]="['/admin/users', user.id]"
                  title="Voir détails">
                  <span class="material-icons">visibility</span>
                </button>
                <button 
                  class="btn-icon" 
                  (click)="openEditModal(user)"
                  title="Modifier">
                  <span class="material-icons">edit</span>
                </button>
                <button 
                  class="btn-icon" 
                  (click)="toggleUserStatus(user)"
                  [title]="user.status === 'active' ? 'Désactiver' : 'Activer'">
                  <span class="material-icons">
                    {{ user.status === 'active' ? 'block' : 'check_circle' }}
                  </span>
                </button>
                <button 
                  class="btn-icon" 
                  (click)="resetPassword(user)"
                  title="Réinitialiser mot de passe">
                  <span class="material-icons">lock_reset</span>
                </button>
                <button 
                  class="btn-icon btn-danger" 
                  (click)="confirmDelete(user)"
                  title="Supprimer">
                  <span class="material-icons">delete</span>
                </button>
              </div>
            </td>
          </tr>
          
          <tr *ngIf="paginatedUsers.length === 0">
            <td colspan="8" class="no-data">
              <span class="material-icons">search_off</span>
              <p>Aucun utilisateur trouvé</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button 
        class="btn-page" 
        (click)="prevPage()" 
        [disabled]="currentPage === 1">
        <span class="material-icons">chevron_left</span>
      </button>
      
      <div class="page-numbers">
        <button 
          *ngFor="let page of [].constructor(totalPages); let i = index"
          class="btn-page"
          [class.active]="i + 1 === currentPage"
          (click)="goToPage(i + 1)">
          {{ i + 1 }}
        </button>
      </div>
      
      <button 
        class="btn-page" 
        (click)="nextPage()" 
        [disabled]="currentPage === totalPages">
        <span class="material-icons">chevron_right</span>
      </button>
    </div>
  </div>
</div>

<!-- User Modal (Create/Edit) -->
<div class="modal-overlay" *ngIf="showUserModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>
        {{ modalMode === 'create' ? 'Créer un Utilisateur' : 
           modalMode === 'edit' ? 'Modifier l\'Utilisateur' : 'Détails de l\'Utilisateur' }}
      </h2>
      <button class="btn-close" (click)="closeModal()">
        <span class="material-icons">close</span>
      </button>
    </div>

    <div class="modal-body" *ngIf="selectedUser">
      <div class="form-group">
        <label>Nom Complet *</label>
        <input 
          type="text" 
          [(ngModel)]="selectedUser.fullName" 
          class="form-control"
          [readonly]="modalMode === 'view'"
          placeholder="Entrez le nom complet"
          required>
      </div>

      <div class="form-group">
        <label>Email *</label>
        <input 
          type="email" 
          [(ngModel)]="selectedUser.email" 
          class="form-control"
          [readonly]="modalMode === 'view'"
          placeholder="Entrez l'email"
          required>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Rôle *</label>
          <select 
            [(ngModel)]="selectedUser.role" 
            class="form-control"
            [disabled]="modalMode === 'view'"
            required>
            <option value="Apprenant">Apprenant</option>
            <option value="Formateur">Formateur</option>
            <option value="Administrateur">Administrateur</option>
          </select>
        </div>

        <div class="form-group">
          <label>Statut *</label>
          <select 
            [(ngModel)]="selectedUser.status" 
            class="form-control"
            [disabled]="modalMode === 'view'"
            required>
            <option value="active">Actif</option>
            <option value="inactive">Inactif</option>
            <option value="pending">En attente</option>
            <option value="suspended">Suspendu</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Formation</label>
          <select 
            [(ngModel)]="selectedUser.training" 
            class="form-control"
            [disabled]="modalMode === 'view'">
            <option value="">Aucune formation</option>
            <option *ngFor="let formation of formations" [value]="formation.title">
              {{ formation.title }}
            </option>
          </select>
          <small class="form-text">Sélectionnez une formation existante</small>
        </div>

        <div class="form-group">
          <label>Niveau</label>
          <select 
            [(ngModel)]="selectedUser.level" 
            class="form-control"
            [disabled]="modalMode === 'view'">
            <option value="Débutant">Débutant</option>
            <option value="Intermédiaire">Intermédiaire</option>
            <option value="Avancé">Avancé</option>
          </select>
        </div>
      </div>
      
      <!-- Password Field -->
      <div class="form-group" *ngIf="modalMode !== 'view'">
        <div class="password-field-header">
          <label>Mot de passe {{ modalMode === 'create' ? '*' : '' }}</label>
          <button 
            type="button" 
            class="btn-link" 
            (click)="togglePasswordField()"
            *ngIf="modalMode === 'edit'">
            {{ showPasswordField ? 'Annuler' : 'Modifier le mot de passe' }}
          </button>
        </div>
        <input 
          *ngIf="showPasswordField || modalMode === 'create'"
          type="password" 
          [(ngModel)]="newPassword" 
          class="form-control"
          [required]="modalMode === 'create'"
          [placeholder]="modalMode === 'create' ? 'Entrez le mot de passe' : 'Laissez vide pour ne pas modifier'">
        <small class="form-text" *ngIf="modalMode === 'edit' && !showPasswordField">
          Le mot de passe ne sera pas modifié si vous ne remplissez pas ce champ
        </small>
      </div>

      <div class="form-group">
        <label>URL de l'Avatar</label>
        <input 
          type="text" 
          [(ngModel)]="selectedUser.avatarUrl" 
          class="form-control"
          [readonly]="modalMode === 'view'"
          placeholder="URL de l'image de profil">
      </div>
    </div>

    <div class="modal-footer" *ngIf="modalMode !== 'view'">
      <button type="button" class="btn btn-secondary" (click)="closeModal()">Annuler</button>
      <button type="button" class="btn btn-primary" (click)="saveUser()">
        <span class="material-icons">save</span>
        {{ modalMode === 'create' ? 'Créer' : 'Sauvegarder' }}
      </button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteConfirm" (click)="showDeleteConfirm = false">
  <div class="modal-content modal-confirm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirmer la Suppression</h2>
      <button class="btn-close" (click)="showDeleteConfirm = false">
        <span class="material-icons">close</span>
      </button>
    </div>

    <div class="modal-body">
      <div class="confirm-icon">
        <span class="material-icons">warning</span>
      </div>
      <p>Êtes-vous sûr de vouloir supprimer l'utilisateur <strong>{{ selectedUser?.fullName }}</strong> ?</p>
      <p class="warning-text">Cette action est irréversible.</p>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="showDeleteConfirm = false">Annuler</button>
      <button class="btn btn-danger" (click)="deleteUser()">
        <span class="material-icons">delete</span>
        Supprimer
      </button>
    </div>
  </div>
</div>




